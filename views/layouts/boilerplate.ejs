<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EduRadar</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico?v=2">
  <link rel="stylesheet" href="/css/style.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <link rel="stylesheet" href="/css/rating.css">
</head>

<body>
  <%- include("../includes/navbar.ejs") %>

    <div class="container-fluid px-0">
      <%- include("../includes/flash.ejs") %>
        <%-body %>
    </div>

    <%- include("../includes/footer.ejs") %>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>
      <script src="/js/script.js"></script>

      <script>
        const path = window.location.pathname;
        const navbarSearch = document.getElementById('navbarSearch');
        const heroSearch = document.getElementById('heroSearch');

        if (path === '/' || path === '/home') {
          window.addEventListener('scroll', function () {
            if (navbarSearch) {
              if (window.scrollY > 250) {
                navbarSearch.style.display = 'flex';
                if (heroSearch) heroSearch.style.display = 'none';
              } else {
                navbarSearch.style.display = 'none';
                if (heroSearch) heroSearch.style.display = 'flex';
              }
            }
          });
        } else {
          if (navbarSearch) navbarSearch.style.display = 'flex';
          if (heroSearch) heroSearch.style.display = 'none';
        }

      </script>
      <% if (currentUser) { %>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    (function () {
      const socket = io(); // Connect to socket.io server
      const userId = "<%= currentUser._id %>";

      // When connected, join user's personal room
      socket.on('connect', () => {
        socket.emit('joinRoom', userId);
        console.log('Socket connected, joined room:', userId);
      });

      // Listen for new notifications
      socket.on('newNotification', (notif) => {
        console.log('New notification:', notif);

        // Update notification badge count
        const badge = document.getElementById('notif-badge');
        if (badge) {
          let count = parseInt(badge.textContent) || 0;
          count++;
          badge.textContent = count;
          badge.style.display = 'inline-block';
          badge.classList.remove('bg-secondary');
          badge.classList.add('bg-danger');
        }

        // Prepend new notification to dropdown list if exists
        const dropdown = document.querySelector('#notifDropdown + .dropdown-menu');
        if (dropdown) {
          const li = document.createElement('li');
          li.className = 'dropdown-item d-flex justify-content-between align-items-start notif-item';
          li.setAttribute('data-id', notif._id);
          li.innerHTML = `
            <div>
              <div>${notif.message}</div>
              <small class="text-muted">${new Date(notif.createdAt).toLocaleString()}</small>
            </div>
            <div>${!notif.read ? '<span class="badge bg-primary">New</span>' : ''}</div>
          `;
          const divider = dropdown.querySelector('li.dropdown-divider');
          if (divider) {
            dropdown.insertBefore(li, divider);
          } else {
            dropdown.prepend(li);
          }
        }
      });

      // Click event to mark notification as read via AJAX
      document.addEventListener('click', function (e) {
        const item = e.target.closest('.notif-item');
        if (item && item.dataset.id) {
          const notifId = item.dataset.id;

          fetch(`/notifications/${notifId}/read`, { method: 'POST' })
            .then(res => res.json())
            .then(() => {
              // Update badge count
              const badge = document.getElementById('notif-badge');
              if (badge) {
                let count = parseInt(badge.textContent) || 0;
                count = Math.max(0, count - 1);
                badge.textContent = count;
                if (count === 0) badge.style.display = 'none';
              }
              item.classList.add('text-muted');
            })
            .catch(() => {
              console.error('Failed to mark notification as read');
            });
        }
      });
    })();
  </script>
<% } %>

</body>

</html>